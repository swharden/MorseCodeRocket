<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Morse Code Rocket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <div class="container my-5">
        <button class="btn btn-primary" onclick="send()">send</button>
        <div id="sent"></div>
    </div>

    <script>

        const audioContext = new window.AudioContext();

        const wpm = 20;

        const ToneQueue = [];

        function EnqueueMessage(text) {
            const morseCode = {
                'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.',
                'F': '..-.', 'G': '--.', 'H': '....', 'I': '..', 'J': '.---',
                'K': '-.-', 'L': '.-..', 'M': '--', 'N': '-.', 'O': '---',
                'P': '.--.', 'Q': '--.-', 'R': '.-.', 'S': '...', 'T': '-',
                'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-', 'Y': '-.--',
                'Z': '--..', '1': '.----', '2': '..---', '3': '...--', '4': '....-',
                '5': '.....', '6': '-....', '7': '--...', '8': '---..', '9': '----.',
                '0': '-----', ' ': ' '
            };

            /*
            The length of a dot is 1 time unit.
            A dash is 3 time units.
            The space between symbols (dots and dashes) of the same letter is 1 time unit.
            The space between letters is 3 time units.
            The space between words is 7 time units.
            */

            text.split("").forEach(char => {
                const letterSymbols = morseCode[char.toUpperCase()];
                if (letterSymbols) {
                    letterSymbols.split("").forEach(letterSymbol => {
                        if (letterSymbol == '.') {
                            ToneQueue.push([1, 1]); // 1 unit on
                            ToneQueue.push([0, 1]); // 1 unit off 
                        } else if (letterSymbol == '-') {
                            ToneQueue.push([1, 3]); // 3 units on
                            ToneQueue.push([0, 1]); // 1 unit off 
                        } else if (letterSymbol == ' ') {
                            ToneQueue.push([0, 3]); // 3 units off between words
                        }
                    });
                    ToneQueue.push([0, 1]); // 1 unit off between letters
                } else {
                    console.error(`Unknown character: ${char}`);
                }
            });
        }

        function SendMessage() {
            if (ToneQueue.length == 0)
                return;
            const msPerUnit = 1.2 / wpm * 1000;
            const nextUnit = ToneQueue.shift();

            const isTone = nextUnit[0] == 1;
            if (isTone) {
                const toneMsec = nextUnit[1] * msPerUnit;
                const waveform = GetToneWaveform(toneMsec);
                PlayWaveform(waveform);
            }

            const delayMsec = nextUnit[1] * msPerUnit;
            setTimeout(() => { SendMessage() }, delayMsec);
        }

        function GetToneWaveform(durationMsec) {
            if (!durationMsec)
                return;
            const values = [];
            const volume = .5;
            const toneHz = 600;
            const sampleFreq = audioContext.sampleRate / toneHz;
            const msPerUnit = 1.2 / wpm * 1000;
            const fadeTimeMsec = msPerUnit / 10;
            const totalSamples = audioContext.sampleRate * durationMsec / 1000;
            const fadeSamples = audioContext.sampleRate * fadeTimeMsec / 1000;
            for (var i = 0; i < totalSamples; i++) {
                values[i] = Math.sin(i / (sampleFreq / (Math.PI * 2))) * volume

                // cosine envelope the start and end
                const isRising = i < fadeSamples;
                const isFalling = i > totalSamples - fadeSamples;
                if (isRising || isFalling) {
                    const frac = isRising
                        ? 1 - (fadeSamples - i) / fadeSamples
                        : (totalSamples - i) / fadeSamples;
                    multiplier = 1 - Math.cos(frac * Math.PI / 2);
                    values[i] *= multiplier;
                }
            }
            return values;
        }

        function PlayWaveform(arr) {
            var buf = new Float32Array(arr.length)
            for (var i = 0; i < arr.length; i++) buf[i] = arr[i]
            var buffer = audioContext.createBuffer(1, buf.length, audioContext.sampleRate)
            buffer.copyToChannel(buf, 0)
            var source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
        }

        function send() {
            EnqueueMessage("CQ CQ de AJ4VD");
            SendMessage();
        }
    </script>
</body>

</html>